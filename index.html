<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- Meta tag essencial para responsividade em celulares -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bella Brownies - Controle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Parisienne&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-pink: #FADADD;
            --secondary-pink: #FFB6C1;
            --accent-brown: #6B4226;
            --white: #FFFFFF;
            --text-dark: #3D2314;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-pink);
            color: var(--text-dark);
        }
        .font-parisienne {
            font-family: 'Parisienne', cursive;
        }
        .tab-button.active {
            background-color: var(--accent-brown);
            color: var(--white);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .table-header {
            background-color: var(--secondary-pink);
        }
        .btn-primary {
            background-color: var(--accent-brown);
            color: var(--white);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #855a3f;
        }
        .input-field {
            border-color: var(--secondary-pink);
        }
        .input-field:focus {
            border-color: var(--accent-brown);
            ring: 1;
            ring-color: var(--accent-brown);
        }
        /* Estilo do lacinho */
        .bow-logo {
            position: relative;
            display: inline-block;
            font-size: 5rem; /* Ajuste o tamanho conforme necessário */
            color: var(--white);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .bow-svg {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%) rotate(-15deg);
            width: 80px;
            height: 80px;
            fill: var(--secondary-pink);
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
        }
        .action-btn {
            cursor: pointer;
            background: none;
            border: none;
            padding: 4px;
            border-radius: 999px;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Conteúdo Principal do App -->
    <div id="app-content" class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <div class="relative inline-block">
                 <svg class="bow-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M17.5,15.5c-1.04,1.04-2.43,1.62-3.89,1.62 s-2.85-0.58-3.89-1.62C8.68,14.46,8,13.28,8,12c0-1.28,0.68-2.46,1.72-3.5C10.76,7.46,12.15,6.88,13.61,6.88 s2.85,0.58,3.89,1.62c1.04,1.04,1.72,2.22,1.72,3.5C19.22,13.28,18.54,14.46,17.5,15.5z M13.61,8.88c-0.83,0-1.5,0.67-1.5,1.5 s0.67,1.5,1.5,1.5s1.5-0.67,1.5-1.5S14.44,8.88,13.61,8.88z M10.61,11.88c-0.83,0-1.5,0.67-1.5,1.5s0.67,1.5,1.5,1.5 s1.5-0.67,1.5-1.5S11.44,11.88,10.61,11.88z"/></svg>
                <h1 class="font-parisienne bow-logo text-5xl sm:text-6xl md:text-7xl">Bella</h1>
            </div>
            <p class="font-parisienne text-3xl sm:text-4xl md:text-5xl -mt-4 text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.2);">brownies</p>
        </header>

        <!-- Navegação das Abas -->
        <div class="flex flex-wrap justify-center gap-2 mb-8">
            <button class="tab-button active px-4 py-2 rounded-lg font-semibold" onclick="openTab('vendas')">Vendas</button>
            <button class="tab-button px-4 py-2 rounded-lg font-semibold" onclick="openTab('a-prazo')">A Prazo</button>
            <button class="tab-button px-4 py-2 rounded-lg font-semibold" onclick="openTab('compras')">Compras</button>
            <button class="tab-button px-4 py-2 rounded-lg font-semibold" onclick="openTab('producao')">Produção</button>
            <button class="tab-button px-4 py-2 rounded-lg font-semibold" onclick="openTab('financeiro')">Financeiro</button>
        </div>

        <!-- Conteúdo das Abas -->
        <main id="tab-content" class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-lg">
            
            <!-- Aba de Vendas -->
            <div id="vendas" class="tab-panel">
                <h2 class="text-2xl font-bold mb-4 text-accent-brown">Registro de Vendas</h2>
                 <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 text-left">Data</th>
                                <th class="p-3 text-left">Cliente</th>
                                <th class="p-3 text-left">Qtd</th>
                                <th class="p-3 text-left">Pgto</th>
                                <th class="p-3 text-left">Total</th>
                                <th class="p-3 text-left">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="vendas-table-body"></tbody>
                    </table>
                </div>
                <button class="btn-primary mt-4 px-4 py-2 rounded-lg" onclick="openModal('vendaModal')">Adicionar Venda</button>
            </div>

            <!-- Aba a Prazo -->
            <div id="a-prazo" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-accent-brown">Clientes a Prazo</h2>
                 <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 text-left">Cliente</th>
                                <th class="p-3 text-left">Valor Devido</th>
                                <th class="p-3 text-left">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="aprazo-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Aba de Compras -->
            <div id="compras" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-accent-brown">Registro de Compras (Estoque de Ingredientes)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 text-left">Data</th>
                                <th class="p-3 text-left">Produto</th>
                                <th class="p-3 text-left">Custo / Unid.</th>
                                <th class="p-3 text-left">Preço Total</th>
                                <th class="p-3 text-left">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="compras-table-body"></tbody>
                    </table>
                </div>
                <button class="btn-primary mt-4 px-4 py-2 rounded-lg" onclick="openModal('compraModal')">Adicionar Compra</button>
            </div>

            <!-- Aba de Produção -->
            <div id="producao" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-accent-brown">Controle de Produção</h2>
                 <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 text-left">Data</th>
                                <th class="p-3 text-left">Feitos</th>
                                <th class="p-3 text-left">Custo/Un</th>
                                <th class="p-3 text-left">Venda</th>
                                <th class="p-3 text-left">Perdidos</th>
                                <th class="p-3 text-left">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="producao-table-body"></tbody>
                    </table>
                </div>
                <button class="btn-primary mt-4 px-4 py-2 rounded-lg" onclick="openModal('producaoModal')">Nova Produção</button>
            </div>

            <!-- Aba Financeiro -->
            <div id="financeiro" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-accent-brown">Controle Financeiro</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-white/90 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-accent-brown">Caixa Atual</h3>
                        <p id="caixa-atual" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                    <div class="bg-white/90 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-accent-brown">Total de Vendas</h3>
                        <p id="total-vendas" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                    <div class="bg-white/90 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-accent-brown">Custos Totais</h3>
                        <p id="custos-totais" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                </div>
                 <div class="mt-6">
                    <button class="btn-primary px-4 py-2 rounded-lg" onclick="openModal('entradaModal')">Adicionar Entrada</button>
                    <button class="bg-red-500 text-white px-4 py-2 rounded-lg ml-2" onclick="openModal('retiradaModal')">Registrar Retirada</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais -->
    <div id="vendaModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-md">
            <h3 id="venda-modal-title" class="text-xl font-bold mb-4">Nova Venda</h3>
            <form id="venda-form">
                <input type="hidden" id="venda-edit-id">
                <input type="hidden" id="venda-old-total">
                <input type="hidden" id="venda-old-pagamento">
                <input id="venda-data" class="w-full p-2 mb-4 border rounded input-field" type="date" required>
                <input id="venda-cliente" class="w-full p-2 mb-4 border rounded input-field" type="text" placeholder="Nome do Cliente" required>
                <input id="venda-quantidade" class="w-full p-2 mb-4 border rounded input-field" type="number" placeholder="Quantidade de Brownies" required>
                <input id="venda-preco-unidade" class="w-full p-2 mb-4 border rounded input-field" type="number" step="0.01" placeholder="Preço por Unidade (R$)" required>
                <select id="venda-pagamento" class="w-full p-2 mb-4 border rounded input-field">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="A Prazo">A Prazo</option>
                </select>
                <div class="flex justify-end gap-4">
                    <button type="button" class="px-4 py-2 rounded" onclick="closeModal('vendaModal')">Cancelar</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="compraModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-md">
            <h3 id="compra-modal-title" class="text-xl font-bold mb-4">Nova Compra</h3>
            <form id="compra-form">
                <input type="hidden" id="compra-edit-id">
                <input type="hidden" id="compra-old-price">
                <input id="compra-data" class="w-full p-2 mb-4 border rounded input-field" type="date" required>
                <input id="compra-produto" class="w-full p-2 mb-4 border rounded input-field" type="text" placeholder="Nome do Produto (ex: Chocolate, Ovos)" required>
                <input id="compra-preco" class="w-full p-2 mb-4 border rounded input-field" type="number" step="0.01" placeholder="Preço Total Pago (R$)" required>
                <div class="flex gap-4">
                    <input id="compra-quantidade" class="w-full p-2 mb-4 border rounded input-field" type="number" step="0.01" placeholder="Qtd Total" required>
                    <input id="compra-unidade" class="w-1/3 p-2 mb-4 border rounded input-field" type="text" placeholder="unid (g, un)" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="px-4 py-2 rounded" onclick="closeModal('compraModal')">Cancelar</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="producaoModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg p-8 w-full max-w-lg my-8">
            <h3 id="producao-modal-title" class="text-xl font-bold mb-4">Nova Produção (1 Forma = 12 Brownies)</h3>
            <form id="producao-form">
                <input type="hidden" id="producao-edit-id">
                <input type="hidden" id="producao-old-cost">
                <input id="producao-data" class="w-full p-2 mb-4 border rounded input-field" type="date" required>
                <h4 class="font-semibold mb-2">Ingredientes (quantidade usada):</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <input id="producao-chocolate" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Chocolate (g)">
                    <input id="producao-manteiga" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Manteiga (g)">
                    <input id="producao-acucar" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Açúcar (g)">
                    <input id="producao-farinha" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Farinha (g)">
                    <input id="producao-ovos" class="w-full p-2 border rounded input-field" type="number" step="1" placeholder="Ovos (unidades)">
                    <input id="producao-outro" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Outros ingredientes (g)">
                </div>
                 <h4 class="font-semibold mb-2">Custos Adicionais (valor em R$):</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <input id="producao-embalagem" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Custo Embalagem (total)">
                    <input id="producao-recheio" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Custo Recheio (total)">
                 </div>
                 <h4 class="font-semibold mb-2">Preço e Perdas:</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <input id="producao-preco-venda" class="w-full p-2 border rounded input-field" type="number" step="0.01" placeholder="Preço de Venda (un)" required>
                    <input id="producao-perdidos" class="w-full p-2 border rounded input-field" type="number" placeholder="Brownies Perdidos (un)" value="0">
                 </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="px-4 py-2 rounded" onclick="closeModal('producaoModal')">Cancelar</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Entrada Financeira -->
    <div id="entradaModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Adicionar Entrada no Caixa</h3>
            <form id="entrada-form">
                <input id="entrada-valor" class="w-full p-2 mb-4 border rounded input-field" type="number" step="0.01" placeholder="Valor da Entrada" required>
                <div class="flex justify-end gap-4">
                    <button type="button" class="px-4 py-2 rounded" onclick="closeModal('entradaModal')">Cancelar</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Retirada Financeira -->
    <div id="retiradaModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Registrar Retirada do Caixa</h3>
            <form id="retirada-form">
                <input id="retirada-valor" class="w-full p-2 mb-4 border rounded input-field" type="number" step="0.01" placeholder="Valor da Retirada" required>
                <div class="flex justify-end gap-4">
                    <button type="button" class="px-4 py-2 rounded" onclick="closeModal('retiradaModal')">Cancelar</button>
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div id="confirmDeleteModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-4">Confirmar Exclusão</h3>
            <p>Você tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button type="button" class="px-4 py-2 rounded" onclick="closeModal('confirmDeleteModal')">Cancelar</button>
                <button id="confirm-delete-btn" type="button" class="bg-red-500 text-white px-4 py-2 rounded">Excluir</button>
            </div>
        </div>
    </div>


    <!-- Script do Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDPisgGzruxqnXzf9hPlb05uCN3hMozt2s",
          authDomain: "crm-silva-tintas.firebaseapp.com",
          projectId: "crm-silva-tintas",
          storageBucket: "crm-silva-tintas.firebasestorage.app",
          messagingSenderId: "37152653096",
          appId: "1:37152653096:web:e84f095a5d364214abda1d",
          measurementId: "G-GNBVRGLZG2"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LÓGICA FINANCEIRA COM FIREBASE ---
        let financeiro = { caixa: 0, vendas: 0, custos: 0 };
        const financeiroDocRef = doc(db, "bella-brownies", "financeiro");
        const caixaEl = document.getElementById('caixa-atual');
        const vendasEl = document.getElementById('total-vendas');
        const custosEl = document.getElementById('custos-totais');
        const entradaForm = document.getElementById('entrada-form');
        const retiradaForm = document.getElementById('retirada-form');

        async function loadFinanceiroData() {
            const docSnap = await getDoc(financeiroDocRef);
            if (docSnap.exists()) {
                financeiro = docSnap.data();
            } else {
                await setDoc(financeiroDocRef, financeiro);
            }
            updateFinanceiroUI();
        }

        async function saveFinanceiroData() {
            await setDoc(financeiroDocRef, financeiro);
        }

        function formatCurrency(value) {
            if (typeof value !== 'number') return 'R$ 0,00';
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        function formatCostPerUnit(value, unit) {
            if (typeof value !== 'number' || !isFinite(value)) return 'R$ 0,00';
             return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 4 }) + ` / ${unit}`;
        }

        function updateFinanceiroUI() {
            caixaEl.textContent = formatCurrency(financeiro.caixa);
            vendasEl.textContent = formatCurrency(financeiro.vendas);
            custosEl.textContent = formatCurrency(financeiro.custos);
        }
        
        entradaForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const valor = parseFloat(document.getElementById('entrada-valor').value);
            if (!isNaN(valor)) {
                financeiro.caixa += valor;
                await saveFinanceiroData();
                updateFinanceiroUI();
                closeModal('entradaModal');
                entradaForm.reset();
            }
        });

        retiradaForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const valor = parseFloat(document.getElementById('retirada-valor').value);
            if (!isNaN(valor)) {
                financeiro.caixa -= valor;
                await saveFinanceiroData();
                updateFinanceiroUI();
                closeModal('retiradaModal');
                retiradaForm.reset();
            }
        });

        // --- LÓGICA DE COMPRAS ---
        const compraForm = document.getElementById('compra-form');
        const comprasTableBody = document.getElementById('compras-table-body');
        const comprasCollectionRef = collection(db, "compras");

        compraForm.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            const preco = parseFloat(document.getElementById('compra-preco').value);
            const quantidade = parseFloat(document.getElementById('compra-quantidade').value);
            const custoPorUnidade = preco / quantidade;
            const editId = document.getElementById('compra-edit-id').value;

            const data = {
                data: document.getElementById('compra-data').value,
                produto: document.getElementById('compra-produto').value,
                precoTotal: preco,
                quantidadeTotal: quantidade,
                unidade: document.getElementById('compra-unidade').value,
                custoPorUnidade: custoPorUnidade
            };

            try {
                if (editId) {
                    const oldPrice = parseFloat(document.getElementById('compra-old-price').value);
                    const docRef = doc(db, "compras", editId);
                    await updateDoc(docRef, data);
                    financeiro.custos = (financeiro.custos - oldPrice) + preco;
                } else {
                    await addDoc(comprasCollectionRef, data);
                    financeiro.custos += preco;
                }
                
                await saveFinanceiroData();
                updateFinanceiroUI();
                closeModal('compraModal');
            } catch (e) {
                console.error("Erro ao salvar compra: ", e);
            }
        });

        function listenToCompras() {
            const q = query(comprasCollectionRef, orderBy("data", "desc"));
            onSnapshot(q, (snapshot) => {
                let comprasHtml = '';
                snapshot.forEach((doc) => {
                    const compra = doc.data();
                    const docId = doc.id;
                    comprasHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="p-3">${new Date(compra.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                            <td class="p-3">${compra.produto}</td>
                            <td class="p-3">${formatCostPerUnit(compra.custoPorUnidade, compra.unidade)}</td>
                            <td class="p-3">${formatCurrency(compra.precoTotal)}</td>
                            <td class="p-3 flex gap-2">
                                <button class="action-btn" onclick="window.openCompraEditModal('${docId}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg>
                                </button>
                                <button class="action-btn" onclick="window.requestDelete('compras', '${docId}', ${compra.precoTotal})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-red-500" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                comprasTableBody.innerHTML = comprasHtml;
            });
        }
        
        window.openCompraEditModal = async (id) => {
            const docRef = doc(db, "compras", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('compra-modal-title').innerText = "Editar Compra";
                document.getElementById('compra-edit-id').value = id;
                document.getElementById('compra-old-price').value = data.precoTotal;
                document.getElementById('compra-data').value = data.data;
                document.getElementById('compra-produto').value = data.produto;
                document.getElementById('compra-preco').value = data.precoTotal;
                document.getElementById('compra-quantidade').value = data.quantidadeTotal;
                document.getElementById('compra-unidade').value = data.unidade;
                openModal('compraModal');
            }
        }

        // --- LÓGICA DE PRODUÇÃO ---
        const producaoForm = document.getElementById('producao-form');
        const producaoTableBody = document.getElementById('producao-table-body');
        const producaoCollectionRef = collection(db, "producao");

        async function getCustoIngrediente(nome, qtdUsada) {
            if (!nome || !qtdUsada || qtdUsada <= 0) return 0;
            const q = query(collection(db, "compras"), where("produto", "==", nome), orderBy("data", "desc"), limit(1));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                 alert(`Atenção: Não foi encontrada uma compra para "${nome}" para calcular o custo. O valor será zero.`);
                 return 0;
            }
            const compraRecente = querySnapshot.docs[0].data();
            return compraRecente.custoPorUnidade * qtdUsada;
        }

        producaoForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const editId = document.getElementById('producao-edit-id').value;
            
            const ingredientes = [
                { nome: 'Chocolate', qtd: parseFloat(document.getElementById('producao-chocolate').value) || 0 },
                { nome: 'Manteiga', qtd: parseFloat(document.getElementById('producao-manteiga').value) || 0 },
                { nome: 'Açúcar', qtd: parseFloat(document.getElementById('producao-acucar').value) || 0 },
                { nome: 'Farinha', qtd: parseFloat(document.getElementById('producao-farinha').value) || 0 },
                { nome: 'Ovos', qtd: parseFloat(document.getElementById('producao-ovos').value) || 0 },
                { nome: 'Outro', qtd: parseFloat(document.getElementById('producao-outro').value) || 0 }
            ];

            let custoIngredientes = 0;
            for (const ing of ingredientes) {
                custoIngredientes += await getCustoIngrediente(ing.nome, ing.qtd);
            }

            const custoEmbalagem = parseFloat(document.getElementById('producao-embalagem').value) || 0;
            const custoRecheio = parseFloat(document.getElementById('producao-recheio').value) || 0;
            const custoTotalProducao = custoIngredientes + custoEmbalagem + custoRecheio;
            const custoUnitario = custoTotalProducao / 12;

            const data = {
                data: document.getElementById('producao-data').value,
                precoVenda: parseFloat(document.getElementById('producao-preco-venda').value),
                perdidos: parseInt(document.getElementById('producao-perdidos').value) || 0,
                custoUnitario: custoUnitario,
                custoTotal: custoTotalProducao,
                browniesFeitos: 12,
                ingredientesUsados: ingredientes // Salva os ingredientes para edição
            };

            try {
                if (editId) {
                    const oldCost = parseFloat(document.getElementById('producao-old-cost').value);
                    const docRef = doc(db, "producao", editId);
                    await updateDoc(docRef, data);
                    financeiro.custos = (financeiro.custos - oldCost) + custoTotalProducao;
                } else {
                    await addDoc(producaoCollectionRef, data);
                    financeiro.custos += custoTotalProducao;
                }
                
                await saveFinanceiroData();
                updateFinanceiroUI();
                closeModal('producaoModal');
            } catch(e) {
                console.error("Erro ao salvar produção: ", e);
            }
        });

        function listenToProducao() {
            const q = query(producaoCollectionRef, orderBy("data", "desc"));
            onSnapshot(q, (snapshot) => {
                let producaoHtml = '';
                snapshot.forEach((doc) => {
                    const p = doc.data();
                    producaoHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="p-3">${new Date(p.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                            <td class="p-3">${p.browniesFeitos}</td>
                            <td class="p-3">${formatCurrency(p.custoUnitario)}</td>
                            <td class="p-3">${formatCurrency(p.precoVenda)}</td>
                            <td class="p-3">${p.perdidos}</td>
                            <td class="p-3 flex gap-2">
                                <button class="action-btn" onclick="window.openProducaoEditModal('${doc.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg>
                                </button>
                                <button class="action-btn" onclick="window.requestDelete('producao', '${doc.id}', ${p.custoTotal})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-red-500" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                producaoTableBody.innerHTML = producaoHtml;
            });
        }
        
        window.openProducaoEditModal = async (id) => {
            const docRef = doc(db, "producao", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const p = docSnap.data();
                document.getElementById('producao-modal-title').innerText = "Editar Produção";
                document.getElementById('producao-edit-id').value = id;
                document.getElementById('producao-old-cost').value = p.custoTotal;
                document.getElementById('producao-data').value = p.data;
                p.ingredientesUsados.forEach(ing => {
                    const el = document.getElementById(`producao-${ing.nome.toLowerCase()}`);
                    if(el) el.value = ing.qtd;
                });
                document.getElementById('producao-embalagem').value = p.custoEmbalagem || '';
                document.getElementById('producao-recheio').value = p.custoRecheio || '';
                document.getElementById('producao-preco-venda').value = p.precoVenda;
                document.getElementById('producao-perdidos').value = p.perdidos;
                openModal('producaoModal');
            }
        };

        // --- LÓGICA DE VENDAS ---
        const vendaForm = document.getElementById('venda-form');
        const vendasTableBody = document.getElementById('vendas-table-body');
        const vendasCollectionRef = collection(db, "vendas");

        vendaForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const total = parseFloat(document.getElementById('venda-quantidade').value) * parseFloat(document.getElementById('venda-preco-unidade').value);
            const pagamento = document.getElementById('venda-pagamento').value;
            const editId = document.getElementById('venda-edit-id').value;

            const data = {
                data: document.getElementById('venda-data').value,
                cliente: document.getElementById('venda-cliente').value,
                quantidade: parseFloat(document.getElementById('venda-quantidade').value),
                precoUnidade: parseFloat(document.getElementById('venda-preco-unidade').value),
                pagamento: pagamento,
                total: total
            };

            try {
                if (editId) {
                    const oldTotal = parseFloat(document.getElementById('venda-old-total').value);
                    const oldPagamento = document.getElementById('venda-old-pagamento').value;
                    
                    // Reverte o valor antigo
                    financeiro.vendas -= oldTotal;
                    if (oldPagamento !== 'A Prazo') financeiro.caixa -= oldTotal;

                    // Adiciona o valor novo
                    financeiro.vendas += total;
                    if (pagamento !== 'A Prazo') financeiro.caixa += total;
                    
                    const docRef = doc(db, "vendas", editId);
                    await updateDoc(docRef, data);

                } else {
                    await addDoc(vendasCollectionRef, data);
                    financeiro.vendas += total;
                    if (pagamento !== 'A Prazo') {
                        financeiro.caixa += total;
                    }
                }
                
                await saveFinanceiroData();
                updateFinanceiroUI();
                closeModal('vendaModal');
            } catch (e) {
                console.error("Erro ao salvar venda: ", e);
            }
        });

        function listenToVendas() {
            const q = query(vendasCollectionRef, orderBy("data", "desc"));
            onSnapshot(q, (snapshot) => {
                let vendasHtml = '';
                snapshot.forEach((doc) => {
                    const v = doc.data();
                    vendasHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="p-3">${new Date(v.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                            <td class="p-3">${v.cliente}</td>
                            <td class="p-3">${v.quantidade}</td>
                            <td class="p-3">${v.pagamento}</td>
                            <td class="p-3">${formatCurrency(v.total)}</td>
                            <td class="p-3 flex gap-2">
                                <button class="action-btn" onclick="window.openVendaEditModal('${doc.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg>
                                </button>
                                <button class="action-btn" onclick="window.requestDelete('vendas', '${doc.id}', null, ${v.total}, '${v.pagamento}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-red-500" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                vendasTableBody.innerHTML = vendasHtml;
            });
        }
        
        window.openVendaEditModal = async (id) => {
            const docRef = doc(db, "vendas", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const v = docSnap.data();
                document.getElementById('venda-modal-title').innerText = "Editar Venda";
                document.getElementById('venda-edit-id').value = id;
                document.getElementById('venda-old-total').value = v.total;
                document.getElementById('venda-old-pagamento').value = v.pagamento;
                document.getElementById('venda-data').value = v.data;
                document.getElementById('venda-cliente').value = v.cliente;
                document.getElementById('venda-quantidade').value = v.quantidade;
                document.getElementById('venda-preco-unidade').value = v.precoUnidade;
                document.getElementById('venda-pagamento').value = v.pagamento;
                openModal('vendaModal');
            }
        };


        // --- LÓGICA DE EXCLUSÃO ---
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let deleteInfo = {};

        window.requestDelete = (collectionName, docId, cost, totalVenda, pagamento) => {
            deleteInfo = { collectionName, docId, cost, totalVenda, pagamento };
            openModal('confirmDeleteModal');
        };

        confirmDeleteBtn.addEventListener('click', async () => {
            const { collectionName, docId, cost, totalVenda, pagamento } = deleteInfo;
            if (!collectionName || !docId) return;

            try {
                await deleteDoc(doc(db, collectionName, docId));
                if (cost) { // Exclusão de compra ou produção
                    financeiro.custos -= cost;
                }
                if (totalVenda) { // Exclusão de venda
                    financeiro.vendas -= totalVenda;
                    if (pagamento !== 'A Prazo') {
                        financeiro.caixa -= totalVenda;
                    }
                }
                await saveFinanceiroData();
                updateFinanceiroUI();
                closeModal('confirmDeleteModal');
            } catch (e) {
                console.error("Erro ao excluir: ", e);
            }
        });

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFinanceiroData(); 
            listenToCompras();
            listenToProducao();
            listenToVendas();
        });


        // --- LÓGICA GERAL (ABAS E MODAIS) ---
        window.openTab = function(tabName) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.remove('hidden');
            event.currentTarget.classList.add('active');
        }

        window.openModal = function(modalId) {
            const formIds = {
                'vendaModal': 'venda-form',
                'compraModal': 'compra-form',
                'producaoModal': 'producao-form'
            };
            if (formIds[modalId]) {
                document.getElementById(formIds[modalId]).reset();
            }

            if (modalId === 'compraModal') {
                document.getElementById('compra-modal-title').innerText = "Nova Compra";
                document.getElementById('compra-edit-id').value = '';
            }
            if (modalId === 'producaoModal') {
                document.getElementById('producao-modal-title').innerText = "Nova Produção";
                document.getElementById('producao-edit-id').value = '';
            }
             if (modalId === 'vendaModal') {
                document.getElementById('venda-modal-title').innerText = "Nova Venda";
                document.getElementById('venda-edit-id').value = '';
            }
            
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) closeModal(modal.id);
            });
        }
    </script>
</body>
</html>
